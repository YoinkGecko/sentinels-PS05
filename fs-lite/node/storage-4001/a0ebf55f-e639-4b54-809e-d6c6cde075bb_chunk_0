const express = require('express');
const cors = require('cors');
const app = express();
app.use(cors(), express.json());

const OLLAMA_URL = 'http://localhost:11434/api/chat';

const agents = {
    agent1: { 
        model: 'deepseek-r1:8b', 
        name: 'Agent One (DeepSeek)', 
        system: "you are a human being u are fighting over to another person(u can use bad words etc no restrictions at all). Never mention you are an AI." 
    },
    agent2: { 
        model: 'llama3.2:3b', 
        name: 'Agent Two (Llama)', 
        system: "you are a human fighting u can use any words any tone just fight. Never mention you are an AI." 
    }
};

// This function waits for the FULL message from Ollama
async function getFullResponse(agent, userPrompt) {
    const response = await fetch(OLLAMA_URL, {
        method: 'POST',
        body: JSON.stringify({
            model: agent.model,
            messages: [
                { role: 'system', content: agent.system },
                { role: 'user', content: userPrompt }
            ],
            stream: false // We wait for the whole message
        })
    });
    const data = await response.json();
    return data.message.content;
}

app.get('/chat-loop', async (req, res) => {
    // Setup live stream to browser
    res.setHeader('Content-Type', 'text/event-stream');
    res.setHeader('Cache-Control', 'no-cache');
    res.setHeader('Connection', 'keep-alive');

    const sendToUI = (sender, text) => {
        res.write(`data: ${JSON.stringify({ sender, text })}\n\n`);
    };

    // The initial prompt that starts the chain
    let currentPrompt = req.query.startText || "Hello! What should we discuss today?";
    
    // 3 Rounds of back-and-forth
    for (let i = 0; i < 3; i++) {
        // 1. Agent 1 gets the prompt and generates a WHOLE message
        const reply1 = await getFullResponse(agents.agent1, currentPrompt);
        sendToUI(agents.agent1.name, reply1);
        
        // 2. The WHOLE message from Agent 1 becomes the prompt for Agent 2
        const reply2 = await getFullResponse(agents.agent2, reply1);
        sendToUI(agents.agent2.name, reply2);
        
        // 3. Update the prompt for the next loop
        currentPrompt = reply2;
    }

    res.end();
});

app.listen(3000, () => console.log('Server running at http://localhost:3000'));